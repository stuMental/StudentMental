<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.student.modules.eyereport.dao.ProDao">

<select id="getRadarjxxg" resultType="java.util.HashMap">
SELECT
	student_study_score,
	student_emotion_score,
	student_mental_score,
	class_concentration_score,
	class_interactivity_score,
	class_positivity_score 
FROM
	class_status_scores 
<!-- 	WHERE college_name = '求实职业学校' AND grade_name = '2017' AND class_name = '17动漫' AND course_name = '德育' AND dt = '2019-07-16'; -->
	
WHERE
	college_name = #{college_name} 
	AND grade_name = #{grade_name} 
	AND class_name = #{class_name} 
	AND course_name = #{course_name} 
	AND dt = #{dt}
	
</select>

<select id="getxsqxzts" resultType="java.util.HashMap">
SELECT
       action_status AS student_emotion, ROUND(rate * 100, 2) AS percentage
FROM class_status_student_daily
<!-- WHERE action_type = 3 AND college_name = '求实职业学校' AND grade_name = '2017' AND class_name = '17动漫' AND course_name = '德育' AND dt = '2019-07-16'
 -->
WHERE
	action_type = 3 
	AND	college_name = #{college_name} 
	AND grade_name = #{grade_name} 
	AND class_name = #{class_name} 
	AND course_name = #{course_name}
	AND dt = #{dt}

</select>


<select id="getxsqxztqx" resultType="java.util.HashMap">
SELECT
       action_status AS student_emotion, ROUND(rate * 100, 2) AS percentage,dt
FROM class_status_student_daily
<!-- WHERE action_type = 3 
AND college_name = '求实职业学校' 
AND grade_name = '2017' 
AND class_name = '17动漫' 
AND course_name = '德育'
 AND dt &gt;= date_add('2019-07-16', interval -15 day) AND dt &lt;= '2019-07-16'
ORDER BY dt ASC
 -->

where action_type = 3  and
	college_name = #{college_name} 
	AND grade_name = #{grade_name} 
	AND class_name = #{class_name} 
	AND course_name = #{course_name}
	AND dt &gt;= date_add( #{dt}, INTERVAL - 15 DAY ) 
	AND dt &lt;= #{dt} 
ORDER BY dt ASC
</select>

<select id="getxsxxzt" resultType="java.util.HashMap">
SELECT
       action_status AS student_study_stat, ROUND(rate * 100, 2) AS percentage
FROM class_status_student_daily
<!--WHERE action_type = 5 AND college_name = '求实职业学校' AND grade_name = '2017' AND class_name = '17动漫' AND course_name = '德育' AND dt = '2019-07-16';
  -->
WHERE
action_type = 5 and 
	college_name = #{college_name} 
	AND grade_name = #{grade_name} 
	AND class_name = #{class_name} 
	AND course_name = #{course_name}
	AND dt = #{dt}

</select>

<select id="getxsxxztqx" resultType="java.util.HashMap">
SELECT
       dt, action_status AS student_study_stat, ROUND(rate * 100, 2) AS percentage
FROM class_status_student_daily
<!-- WHERE action_type = 5 AND college_name = '求实职业学校' AND grade_name = '2017' AND class_name = '17动漫' AND course_name = '德育' AND dt &gt;= date_add('2019-07-16', interval -15 day) AND dt &lt;= '2019-07-16'
ORDER BY dt ASC;
 -->
WHERE
action_type = 5 and 
	college_name = #{college_name} 
	AND grade_name = #{grade_name} 
	AND class_name = #{class_name} 
	AND course_name = #{course_name}
	AND dt &gt;= date_add( #{dt}, INTERVAL - 15 DAY ) 
	AND dt &lt;= #{dt} 

</select>




<select id="getxsjszt" resultType="java.util.HashMap">
SELECT
       action_status AS student_mental_stat, ROUND(rate * 100, 2) AS percentage
FROM class_status_student_daily
<!-- WHERE action_type = 4 AND college_name = '求实职业学校' AND grade_name = '2017' AND class_name = '17动漫' AND course_name = '德育' AND dt = '2019-07-16'
 -->
WHERE
    action_type = 4
	and college_name = #{college_name} 
	AND grade_name = #{grade_name} 
	AND class_name = #{class_name} 
	AND course_name = #{course_name}
	AND dt = #{dt}

</select>
<select id="getxsjsztqx" resultType="java.util.HashMap">
SELECT
       dt, action_status AS student_mental_stat, ROUND(rate * 100, 2) AS percentage
FROM class_status_student_daily
<!--WHERE action_type = 4 AND college_name = '求实职业学校' AND grade_name = '2017' AND class_name = '17动漫' AND course_name = '德育' AND dt &gt;= date_add('2019-07-16', interval -15 day) AND dt &lt;= '2019-07-16'
ORDER BY dt ASC; -->
 WHERE action_type = 4 AND
	college_name = #{college_name} 
	AND grade_name = #{grade_name} 
	AND class_name = #{class_name} 
	AND course_name = #{course_name}
	AND dt &gt;= date_add( #{dt}, INTERVAL - 15 DAY ) 
	AND dt &lt;= #{dt} 

</select>

<select id="getktjjx" resultType="java.util.HashMap">
SELECT
	class_positivity 
FROM
	class_status_daily 
	<!-- WHERE college_name = '求实职业学校' AND grade_name = '2017' AND class_name = '17动漫' AND course_name = '德育' AND dt = '2019-06-21'; -->
	
WHERE
	college_name = #{college_name} 
	AND grade_name = #{grade_name} 
	AND class_name = #{class_name} 
	AND course_name = #{course_name}
	AND dt = #{dt}
</select>
<select id="getktjjxqx" resultType="java.util.HashMap">
SELECT
	dt,
	class_positivity 
FROM
	class_status_daily 
WHERE
	college_name = #{college_name} 
	AND grade_name = #{grade_name} 
	AND class_name = #{class_name} 
	AND course_name = #{course_name}
	AND dt &gt;= date_add( #{dt}, INTERVAL - 15 DAY ) 
	AND dt &lt;= #{dt} 
ORDER BY
	dt ASC
</select>



<select id="getktzzd" resultType="java.util.HashMap">
SELECT
	class_concentration 
FROM
	class_status_daily 
<!-- 	WHERE college_name = '求实职业学校' AND grade_name = '2017' AND class_name = '17动漫' AND course_name = '德育' AND dt = '2019-06-21';-->
	
WHERE
	college_name = #{college_name} 
	AND grade_name = #{grade_name} 
	AND class_name = #{class_name} 
	AND course_name = #{course_name}
	AND dt = #{dt} 
</select>
<select id="getktzzdqx" resultType="java.util.HashMap">
SELECT
	dt,
	class_concentration 
FROM
	class_status_daily 
WHERE
	college_name = #{college_name} 
	AND grade_name = #{grade_name} 
	AND class_name = #{class_name} 
	AND course_name = #{course_name}
	AND dt &gt;= date_add( #{dt}, INTERVAL - 15 DAY ) 
	AND dt &lt;= #{dt} 
ORDER BY
	dt ASC
</select>


<select id="getkthdx" resultType="java.util.HashMap">
SELECT
	class_interactivity 
FROM
	class_status_daily 
<!-- 	WHERE college_name = '求实职业学校' AND grade_name = '2017' AND class_name = '17动漫' AND course_name = '德育' AND dt = '2019-06-21';-->
	
WHERE
	college_name = #{college_name} 
	AND grade_name = #{grade_name} 
	AND class_name = #{class_name} 
	AND course_name = #{course_name}
	AND dt = #{dt} 
</select>
<select id="getkthdxqx" resultType="java.util.HashMap">
SELECT
	dt,
	class_interactivity 
FROM
	class_status_daily 
WHERE
	college_name = #{college_name} 
	AND grade_name = #{grade_name} 
	AND class_name = #{class_name} 
	AND course_name = #{course_name}
	AND dt &gt;= date_add( #{dt}, INTERVAL - 15 DAY ) 
	AND dt &lt;= #{dt} 
ORDER BY
	dt ASC
</select>

<select id="getktztxxfx" resultType="java.util.HashMap">
SELECT
	dt,
	course_name,
	study_level,
	grade_level 
FROM
	class_status_grade_study_daily 
WHERE
	college_name = #{college_name} 
	AND grade_name = #{grade_name} 
	AND class_name = #{class_name} 
	AND course_name = #{course_name}
	AND dt &gt;= #{dt}
	AND dt &lt;= date_add( #{dt}, INTERVAL  60 DAY ) 
</select>

<select id="getstatistics" resultType="java.util.HashMap">
SELECT * FROM school_student_count_people_rtl ORDER BY room_addr ASC
</select>

<select id="getstatisticspage" resultType="java.util.HashMap">
 select dt,total FROM school_student_count_people
 where room_addr=#{roomaddr}
 and dt &gt;=#{date1}
 and dt &lt;=#{date2}
 ORDER BY dt asc
</select>


<select id="getteachlist" resultType="java.util.HashMap">
select  DISTINCT t.tea_id,t.tea_name from school_course_info t
</select>
<select id="getcourselist" resultType="java.util.HashMap">
select DISTINCT t.course_name,t.course_id from school_course_info t
where 1=1
<if test="college_name != null ">
and t.college_name=#{college_name}
</if>
<if test="class_name != null ">
and t.class_name=#{class_name}
</if>
<if test="grade_name != null ">
and t.grade_name=#{grade_name}
</if>
</select>


<delete id="deleteschool_camera">
		delete from school_camera_class_info 
	</delete>
	<delete id="deleteschool_student">
		delete from school_student_class_info
		<!--DELETE from school_student_class_info, k_school_performance_info, k_school_award_info, student_image, k_school_student_course_info WHERE student_number = #{}-->
	</delete>
	<delete id="deleteschool_course">
		delete from school_course_info 
	</delete>











<insert id="insertschool_camera" parameterType="java.util.List" useGeneratedKeys="false">
    			insert into school_camera_class_info
    			( camera_id,camera_addr,class_id,class_name,grade_name,dt)
    			values
    			<foreach collection="list" item="item" index="index" separator=",">
    				(
    					#{item.camera_id},
    					#{item.camera_addr},
    					#{item.class_id},
    					#{item.class_name},
    					#{item.grade_name},
    					#{item.dt}
    				)
    		     </foreach>		
    </insert> 
    <insert id="insertschool_student" parameterType="java.util.List" useGeneratedKeys="false">
    			insert into school_student_class_info
    			( grade_name,class_name,student_number,student_name,dt)
    			values
    			<foreach collection="list" item="item" index="index" separator=",">
    				(
    					#{item.grade_name},
    					#{item.class_name},
    					#{item.student_number},
    					#{item.student_name},
    					#{item.dt}
    				)
    		     </foreach>		
    </insert> 
    <insert id="insertschool_course" parameterType="java.util.List" useGeneratedKeys="false">
    			insert into school_course_info
    			( course_id,course_name,tea_id,tea_name,class_name,grade_name,start_time,end_time,dt,weekday)
    			values
    			<foreach collection="list" item="item" index="index" separator=",">
    				(
    					#{item.course_id},
    					#{item.course_name},
    					#{item.tea_id},
    					#{item.tea_name},
    					#{item.class_name},
    					#{item.grade_name},
    					#{item.start_time},
    					#{item.end_time},
    					#{item.dt},
    					#{item.weekday}
    				)
    		     </foreach>		
    </insert> 
    <insert id="insertschool_performance" parameterType="java.util.List" useGeneratedKeys="false">
    			insert into school_performance_info
    			( student_number,student_name,grade_name,class_name,college_name,course_id,course_name,score,dt)
    			values
    			<foreach collection="list" item="item" index="index" separator=",">
    				(
    					#{item.student_number},
    					#{item.student_name},
    					#{item.grade_name},
    					#{item.class_name},
    					#{item.college_name},
    					#{item.course_id},
    					#{item.course_name},
    					#{item.score},
    					#{item.dt}
    				)
    		     </foreach>		
    </insert> 
    <insert id="insertschool_award" parameterType="java.util.List" useGeneratedKeys="false">
    			insert into school_award_info
    			( student_number,student_name,grade_name,class_name,college_name,award_type,award_level,award_name,dt)
    			values
    			<foreach collection="list" item="item" index="index" separator=",">
    				(
    					#{item.student_number},
    					#{item.student_name},
    					#{item.grade_name},
    					#{item.class_name},
    					#{item.college_name},
    					#{item.award_type},
    					#{item.award_level},
    					#{item.award_name},
    					#{item.dt}
    				)
    		     </foreach>		
    </insert> 









	<select id="student_interest" resultType="java.util.HashMap">
	SELECT
        CONCAT('- ', student_interest) AS name
    FROM student_mental_status_interest_daily
    WHERE student_number = #{studentid} AND dt &gt;= #{date1} AND dt &lt;= #{date2}
    GROUP BY student_interest
    ORDER BY student_interest ASC
	</select>
	
	<select id="student_award_info" resultType="java.util.HashMap">
	SELECT
        CONCAT('- ', award_type) AS name
    FROM school_award_info
   WHERE student_number = #{studentid} AND dt &gt;= #{date1} AND dt &lt;= #{date2}
    GROUP BY award_type
    ORDER BY award_type ASC
	</select>
	
	<select id="getstudent_mental_status_ld" resultType="string">
	SELECT
	student_relationship
    FROM
    (
        SELECT
            student_relationship, COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE student_number = #{studentid}  AND student_relationship != '' AND dt &gt;= #{date1} AND dt &lt;= #{date2}
        GROUP BY student_relationship
    ) t
    ORDER BY t.student_relationship ASC, t.total DESC
    LIMIT 0, 1;
	</select>
	
	<select id="getlinestudent" resultType="java.util.HashMap">
	SELECT
        case when t1.student_emotion=0 then '开心'
when t1.student_emotion=1 then '正常'
when t1.student_emotion=2 then '低落' ELSE '其他' end  as `name`, ROUND((1.0 * t1.num) / t2.total * 100, 2) AS value
    FROM
    (
        SELECT
            student_number, student_emotion, COUNT(*) AS num
        FROM student_mental_status_ld
        WHERE student_number = #{studentid} AND dt &gt;= #{date1} AND dt &lt;= #{date2}
        GROUP BY student_number, student_emotion
    ) t1 JOIN
    (
        SELECT
            student_number, COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE student_number = #{studentid} AND dt &gt;= #{date1} AND dt &lt;= #{date2}
        GROUP BY student_number
    ) t2 ON t1.student_number = t2.student_number
	</select>
	
	
	
	<select id="getbq" resultType="java.util.HashMap">
	SELECT
        dt, student_emotion
    FROM student_mental_status_ld
    WHERE student_number = #{studentid}  AND dt &gt;= #{date1} AND dt &lt;= #{date2}
    ORDER BY dt ASC
	</select>
	
	
	<select id="getjsztdata" resultType="java.util.HashMap">
	SELECT
        case when t1.student_mental_stat=0 then '积极'
when t1.student_mental_stat=1 then '正常'
when t1.student_mental_stat=2 then '疲惫'  ELSE '其他' end as name, ROUND((1.0 * t1.num) / t2.total * 100, 2) AS value
    FROM
    (
        SELECT
            student_mental_stat, COUNT(*) AS num
        FROM student_mental_status_ld
    WHERE student_number = #{studentid}  AND dt &gt;= #{date1} AND dt &lt;= #{date2}
        GROUP BY student_mental_stat
    ) t1 JOIN
    (
        SELECT
            COUNT(*) AS total
        FROM student_mental_status_ld
    WHERE student_number = #{studentid}  AND dt &gt;= #{date1} AND dt &lt;= #{date2}
    ) t2;
	</select>
	<select id="getxxztdata" resultType="java.util.HashMap">
	 SELECT
       case when t1.student_study_stat=0 then '非常好'
when t1.student_study_stat=1 then '良好'
when t1.student_study_stat=2 then '正常' when t1.student_study_stat=3 then '不佳' ELSE '其他' end  as name, ROUND((1.0 * t1.num) / t2.total * 100, 2) AS value
    FROM
    (
        SELECT
            student_study_stat, COUNT(*) AS num
        FROM student_mental_status_ld
    WHERE student_number = #{studentid}  AND dt &gt;= #{date1} AND dt &lt;= #{date2}
        GROUP BY student_study_stat
    ) t1 JOIN
    (
        SELECT
            COUNT(*) AS total
        FROM student_mental_status_ld
    WHERE student_number = #{studentid}  AND dt &gt;= #{date1} AND dt &lt;= #{date2}
    ) t2
	</select>
	
	
	
	<select id="getjsztline" resultType="java.util.HashMap">
	 SELECT
        dt, student_mental_stat
    FROM student_mental_status_ld
    WHERE student_number = #{studentid}  AND dt &gt;= #{date1} AND dt &lt;= #{date2}
    ORDER BY dt ASC;
	</select>
	
	
	
	<select id="getxxztline" resultType="java.util.HashMap">
	 SELECT
        dt, student_study_stat
    FROM student_mental_status_ld
    WHERE student_number = #{studentid}  AND dt &gt;= #{date1} AND dt &lt;= #{date2}
    ORDER BY dt ASC;
	</select>
	
	
	
	<select id="getxszt" resultType="java.util.HashMap">
	SELECT
        IFNULL(ROUND((1.0 * IFNULL(t5.emotion_count, 0)) / t1.total, 2),0) AS emotion, IFNULL(ROUND((1.0 * IFNULL(t2.study_count, 0)) / t1.total, 2),0) AS study, IFNULL(ROUND((1.0 * IFNULL(t3.mental_count, 0)) / t1.total, 2),0) AS mental, IFNULL(ROUND((1.0 * IFNULL(t4.relationship_count, 0)) / t1.total, 2),0) AS relationship
    FROM
    (
        SELECT
            COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE student_number = #{studentid} AND dt &gt;= #{date1} AND dt &lt;= #{date2}
    ) t1 JOIN
    (
        SELECT
            COUNT(*) AS study_count
        FROM student_mental_status_ld
        WHERE student_number = #{studentid} AND dt &gt;= #{date1} AND dt &lt;= #{date2} AND student_study_stat != '3'
    ) t2 JOIN
    (
        SELECT
            COUNT(*) AS mental_count
        FROM student_mental_status_ld
        WHERE student_number = #{studentid} AND dt &gt;= #{date1} AND dt &lt;= #{date2} AND student_mental_stat != '2'
    ) t3 JOIN
    (
        SELECT
            COUNT(*) AS relationship_count
        FROM student_mental_status_ld
        WHERE student_number = #{studentid} AND dt &gt;= #{date1} AND dt &lt;= #{date2} AND student_relationship != '3' AND student_relationship != ''
    ) t4 JOIN
    (
        SELECT
            COUNT(*) AS emotion_count
        FROM student_mental_status_ld
        WHERE student_number = #{studentid} AND dt &gt;= #{date1} AND dt &lt;= #{date2} AND student_emotion != '2'
    ) t5;
	</select>
	
	<select id="getaditor" resultType="java.util.HashMap">
	 SELECT
        course_name, grade_level, study_level
    FROM student_mental_status_grade_study_daily
    WHERE student_number = #{studentid} AND dt &gt;= #{date1} AND dt &lt;= #{date2}
    ORDER BY course_name ASC;
	</select>

	<select id="getDiagnosisClass" resultType="java.util.HashMap">
		SELECT
		dt,
		course_name,
		study_level,
		grade_level
		FROM
		class_status_grade_study_daily
		WHERE
		college_name = #{college_name}
		AND grade_name = #{grade_name}
		AND class_name = #{class_name}
		AND dt = #{dt}
		ORDER BY course_name ASC;
		<!--AND dt &lt;= date_add( #{dt}, INTERVAL  60 DAY )-->
	</select>

	<select id="getDiagnosisStu" resultType="java.util.HashMap">
		SELECT
		course_name, grade_level, study_level
		FROM student_mental_status_grade_study_daily
		WHERE student_number = #{studentid}
		AND dt = #{dt}
		ORDER BY course_name ASC;
	</select>

	<!-- 暂无作用 -->
		<select id="getclsdetailqxzt" resultType="java.util.HashMap">
	 SELECT
	DISTINCT student_number, student_name, case when student_emotion=0 then '开心'
when student_emotion=1 then '正常'
when student_emotion=2 then '低落' ELSE '其他' end  as student_data
FROM student_mental_status_ld
WHERE (grade_name = #{grade_name} or ''=#{grade_name}) and (class_name = #{class_name} or ''=#{class_name}) AND dt = #{day}
ORDER BY student_emotion DESC;
	</select>
		<select id="getclsdetailrjgx" resultType="java.util.HashMap">
	 SELECT
	DISTINCT student_number, student_name, case when student_relationship=0 then '非常好'
when student_relationship=1 then '良好'
when student_relationship=2 then '正常' when student_relationship=3 then '孤僻' ELSE '其他' end   as student_data
FROM student_mental_status_ld
WHERE (grade_name = #{grade_name} or ''=#{grade_name}) and (class_name = #{class_name} or ''=#{class_name}) AND dt = #{day}
ORDER BY student_relationship DESC;
	</select>
		<select id="getclsdetailxxzt" resultType="java.util.HashMap">
	SELECT
	DISTINCT student_number, student_name, case when student_study_stat=0 then '非常好'
when student_study_stat=1 then '良好'
when student_study_stat=2 then '正常' when student_study_stat=3 then '不佳' ELSE '其他' end  as student_data
FROM student_mental_status_ld
WHERE (grade_name = #{grade_name} or ''=#{grade_name}) and (class_name = #{class_name} or ''=#{class_name}) AND dt = #{day}
ORDER BY student_study_stat DESC;
	</select>
		<select id="getclsdetailjszt" resultType="java.util.HashMap">
	 SELECT
	DISTINCT student_number, student_name, case when student_mental_stat=0 then '积极'
when student_mental_stat=1 then '正常'
when student_mental_stat=2 then '疲惫'  ELSE '其他' end as student_data
FROM student_mental_status_ld
WHERE (grade_name = #{grade_name} or ''=#{grade_name}) and (class_name = #{class_name} or ''=#{class_name}) AND dt = #{day}
ORDER BY student_mental_stat DESC;
	</select>
	
	<!-- 无作用 ^| -->
	
	
	
	
	<!-- 学生结束 -->
<!--  	<select id="getstu"    resultType="java.util.HashMap">
	SELECT DISTINCT
	student_name as label,
	student_number as value
FROM
	school_student_class_info
WHERE 1=1
<if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>


	
	</select>
	-->
	<select id="getstu"    resultType="java.util.HashMap">
	select 
	student_name as label,
	student_number as value
	from school_student_course_info
	WHERE 1=1
<if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
	group by student_name,student_number
order by student_name
	
	</select>
	
	
	<!-- 学校开始 -->
	<select id="geta" resultType="java.util.HashMap">
        SELECT CONCAT(SUBSTR(start_time,1,5),'_',SUBSTR(end_time,1,5)) as time_gap, grade_name, count(*) AS num
        FROM school_student_attendance_info
        WHERE dt=#{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
        GROUP BY start_time,end_time,grade_name
        order by time_gap asc
	</select>
	
	<select id="getcols" resultType="java.util.HashMap">

select
'time_gap' as prop,
'时间' as label
union
select
'grade_name' as prop,
'年级' as label
union
select
'num' as prop,
'缺勤人数' as label

</select>


<select id="getqxdata" resultType="java.util.HashMap">

    SELECT
        case when t1.student_emotion=0 then '开心'
when t1.student_emotion=1 then '正常'
when t1.student_emotion=2 then '低落' ELSE '其他' end  as `name`, ROUND(1.0 * t1.num / t2.total * 100, 2) AS `value`
    FROM
    (
        SELECT
            student_emotion, COUNT(*) AS num
        FROM student_mental_status_ld
        WHERE dt = #{day}
          <if test="college_name != null ">
and college_name=#{college_name}
</if>
        GROUP BY student_emotion
    ) t1 JOIN
    (
        SELECT
            COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE dt = #{day}
          <if test="college_name != null ">
and college_name=#{college_name}
</if>
    ) t2
</select>

<select id="getrjdata"  resultType="java.util.HashMap">
 SELECT
      case when t1.student_relationship=0 then '非常好'
when t1.student_relationship=1 then '良好'
when t1.student_relationship=2 then '正常' when t1.student_relationship=3 then '孤僻' ELSE '其他' end   as name, ROUND(1.0 * t1.num / t2.total * 100, 2) AS value
    FROM
    (
        SELECT
            student_relationship, COUNT(*) AS num
        FROM student_mental_status_ld
        WHERE dt=#{day}
          <if test="college_name != null ">
and college_name=#{college_name}
</if>
        GROUP BY student_relationship
    ) t1 JOIN
    (
        SELECT
            COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE dt=#{day}
          <if test="college_name != null ">
and college_name=#{college_name}
</if>
    ) t2
</select>

<select id="getxxdata"  resultType="java.util.HashMap">
 SELECT
          case when t1.student_study_stat=0 then '非常好'
when t1.student_study_stat=1 then '良好'
when t1.student_study_stat=2 then '正常' when t1.student_study_stat=3 then '不佳' ELSE '其他' end  as name, ROUND(1.0 * t1.num / t2.total * 100, 2) AS value
    FROM
    (
        SELECT
            student_study_stat, COUNT(*) AS num
        FROM student_mental_status_ld
        WHERE dt = #{day}
          <if test="college_name != null ">
and college_name=#{college_name}
</if>
        GROUP BY student_study_stat
    ) t1 JOIN
    (
        SELECT
            COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE dt =  #{day}
          <if test="college_name != null ">
and college_name=#{college_name}
</if>
    ) t2;
</select>
<select id="getjsdata"  resultType="java.util.HashMap">
 SELECT
     case when t1.student_mental_stat=0 then '积极'
when t1.student_mental_stat=1 then '正常'
when t1.student_mental_stat=2 then '疲惫'  ELSE '其他' end as name, ROUND(1.0 * t1.num / t2.total * 100, 2) AS value
    FROM
    (
        SELECT
            student_mental_stat, COUNT(*) AS num
        FROM student_mental_status_ld
        WHERE dt =#{day}
          <if test="college_name != null ">
and college_name=#{college_name}
</if>
        GROUP BY student_mental_stat
    ) t1 JOIN
    (
        SELECT
            COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE dt = #{day}
          <if test="college_name != null ">
and college_name=#{college_name}
</if>
    ) t2;
</select>


<select id="getxkxqdata"  resultType="java.util.HashMap">
 SELECT
        student_interest, COUNT(*) AS total
    FROM student_mental_status_interest_daily
    WHERE dt = #{day}
      <if test="college_name != null ">
and college_name=#{college_name}
</if>
    GROUP BY student_interest
    ORDER BY student_interest ASC;
</select>

<select id="getqxbjdata"  resultType="java.util.HashMap">
 SELECT grade_name, GROUP_CONCAT(student_name separator ',') as qx
    FROM (
        SELECT student_number, student_name, grade_name, count(*) as num
        FROM student_mental_status_ld
        WHERE dt &gt;=date_sub(str_to_date(#{day},'%Y-%m-%d'),interval 15 DAY) AND dt &lt;=#{day} AND student_emotion='2'
          <if test="college_name != null ">
and college_name=#{college_name}
</if>
        GROUP BY student_number, student_name, grade_name
        HAVING num &gt;=6
    )t1 
    GROUP BY grade_name
</select>
<select id="getjsbjdata"  resultType="java.util.HashMap">
 SELECT grade_name, GROUP_CONCAT(student_name separator ',') as js
    FROM (
        SELECT student_number, student_name, grade_name, count(*) as num
        FROM student_mental_status_ld
        WHERE dt &gt;=#{day} -date_sub(str_to_date(#{day},'%Y-%m-%d'),interval 15 DAY) AND dt &lt;=#{day} AND student_mental_stat='2'
          <if test="college_name != null ">
and college_name=#{college_name}
</if>
        GROUP BY student_number, student_name, grade_name
        HAVING num&gt;=6
    )t1 
    GROUP BY grade_name
</select>
<select id="getxxbjdata"  resultType="java.util.HashMap">
SELECT grade_name, GROUP_CONCAT(student_name separator ',') as xx
    FROM (
        SELECT student_number, student_name,grade_name, count(*) as num
        FROM student_mental_status_ld
        WHERE dt &gt;=date_sub(str_to_date(#{day},'%Y-%m-%d'),interval 15 DAY) AND dt &lt;=#{day}  AND student_study_stat='3'
          <if test="college_name != null ">
and college_name=#{college_name}
</if>
        GROUP BY student_number, student_name, grade_name
        HAVING num&gt;=6
    )t1 
    GROUP BY grade_name
</select>

<!-- 学校结束 -->

<!-- 年级开始 -->
<select id="getagrad" resultType="java.util.HashMap">
        SELECT CONCAT(SUBSTR(start_time,1,5),'_',SUBSTR(end_time,1,5)) as time_gap, class_name, count(*) AS num
        FROM school_student_attendance_info
        WHERE dt=#{day} 
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
        GROUP BY start_time,end_time,class_name
        order by time_gap asc
	</select>
	
	<select id="getcolsgrad" resultType="java.util.HashMap">

select 
'time_gap' as prop,
'时间' as label
union
SELECT
'class_name' as prop,
'班级' as label
union
SELECT
'num' as prop,
'缺勤人数' as label


</select>


<select id="getqxdatagrad" resultType="java.util.HashMap">

SELECT
         case when t1.student_emotion=0 then '开心'
when t1.student_emotion=1 then '正常'
when t1.student_emotion=2 then '低落' ELSE '其他' end  as `name`, ROUND(1.0 * t1.num / t2.total * 100, 2) AS `value`
    FROM
    (
        SELECT
            student_emotion, COUNT(*) AS num
        FROM student_mental_status_ld
        WHERE  dt = #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
        GROUP BY student_emotion
    ) t1 JOIN
    (
        SELECT
            COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE  dt = #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
    ) t2
</select>

<select id="getrjdatagrad"  resultType="java.util.HashMap">

SELECT
        case when t1.student_relationship=0 then '非常好'
when t1.student_relationship=1 then '良好'
when t1.student_relationship=2 then '正常' when t1.student_relationship=3 then '孤僻' ELSE '其他' end   as name, ROUND(1.0 * t1.num / t2.total * 100, 2) AS value
    FROM
    (
        SELECT
            student_relationship, COUNT(*) AS num
        FROM student_mental_status_ld
        WHERE  dt = #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
        GROUP BY student_relationship
    ) t1 JOIN
    (
        SELECT
            COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE  dt = #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
    ) t2
</select>

<select id="getxxdatagrad"  resultType="java.util.HashMap">

SELECT
        case when t1.student_study_stat=0 then '非常好'
when t1.student_study_stat=1 then '良好'
when t1.student_study_stat=2 then '正常' when t1.student_study_stat=3 then '不佳' ELSE '其他' end  as name, ROUND(1.0 * t1.num / t2.total * 100, 2) AS value
    FROM
    (
        SELECT
            student_study_stat, COUNT(*) AS num
        FROM student_mental_status_ld
        WHERE dt = #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
        GROUP BY student_study_stat
    ) t1 JOIN
    (
        SELECT
            COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE  dt = #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
    ) t2
</select>
<select id="getjsdatagrad"  resultType="java.util.HashMap">


    SELECT
        case when t1.student_mental_stat=0 then '积极'
when t1.student_mental_stat=1 then '正常'
when t1.student_mental_stat=2 then '疲惫'  ELSE '其他' end as name, ROUND(1.0 * t1.num / t2.total * 100, 2) AS value
    FROM
    (
        SELECT
            student_mental_stat, COUNT(*) AS num
        FROM student_mental_status_ld
        WHERE   dt = #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
        GROUP BY student_mental_stat
    ) t1 JOIN
    (
        SELECT
            COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE  dt = #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
    ) t2
</select>


<select id="getxkxqdatagrad"  resultType="java.util.HashMap">
  SELECT
        student_interest, COUNT(*) AS total
    FROM student_mental_status_interest_daily
    WHERE   dt = #{day}
    <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
    GROUP BY student_interest
    ORDER BY student_interest ASC;
</select>

<select id="getqxbjdatagrad"  resultType="java.util.HashMap">
SELECT class_name, GROUP_CONCAT(student_name separator ',') as qx
    FROM (
        SELECT student_number, student_name, class_name, count(*) as num
        FROM student_mental_status_ld
        WHERE dt &gt;=date_sub(str_to_date(#{day},'%Y-%m-%d'),interval 15 DAY) AND dt &lt;=#{day} AND student_emotion='2' 
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
        GROUP BY student_number, student_name, class_name
        HAVING num &gt;=6
    )t1 
    GROUP BY class_name
</select>
<select id="getjsbjdatagrad"  resultType="java.util.HashMap">
 SELECT class_name, GROUP_CONCAT(student_name separator ',') as js
    FROM (
        SELECT student_number, student_name, class_name, count(*) as num
        FROM student_mental_status_ld
        WHERE dt &gt;=date_sub(str_to_date(#{day},'%Y-%m-%d'),interval 15 DAY) AND dt &lt;=#{day} AND student_mental_stat='2'
              <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
        GROUP BY student_number, student_name, class_name
        HAVING num&gt;=6
    )t1 
    GROUP BY class_name
</select>
<select id="getxxbjdatagrad"  resultType="java.util.HashMap">
SELECT class_name, GROUP_CONCAT(student_name separator ',') as xx
    FROM (
        SELECT student_number, student_name,class_name, count(*) as num
        FROM student_mental_status_ld
        WHERE dt &gt;=date_sub(str_to_date(#{day},'%Y-%m-%d'),interval 15 DAY) AND dt &lt;=#{day}  AND student_study_stat='3'
              <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
        GROUP BY student_number, student_name, class_name
        HAVING num&gt;=6
    )t1 
    GROUP BY class_name
</select>


<!-- 年级结束 -->


<!-- 班级开始 -->

<select id="getacls" resultType="java.util.HashMap">
SELECT
    *
FROM (
    SELECT
        t1.time_gap, t1.course_name, t1.num, t1.name, IFNULL(t2.name, '无') as attend_name, (t1.num + IFNULL(t2.num, 0)) as total
    FROM (
        SELECT CONCAT(SUBSTR(start_time,1,5),'_',SUBSTR(end_time,1,5)) as time_gap, course_name, count(*) AS num, GROUP_CONCAT(student_name ORDER BY student_name ASC) as name
        FROM school_student_attendance_info
        WHERE dt=#{day} 
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
        GROUP BY start_time,end_time,course_name
    ) t1 LEFT JOIN (
        SELECT CONCAT(SUBSTR(start_time,1,5),'_',SUBSTR(end_time,1,5)) as time_gap, course_name, count(*) AS num, GROUP_CONCAT(student_name ORDER BY student_name ASC) as name
        FROM school_student_attendance_exist_info
        WHERE dt=#{day} 
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
        GROUP BY start_time,end_time,course_name
    ) t2 ON t1.time_gap = t2.time_gap AND t1.course_name = t2.course_name

    UNION

    SELECT
        t4.time_gap, t4.course_name, IFNULL(t3.num, 0) as num, IFNULL(t3.name, '无') as name, t4.name as attend_name, (IFNULL(t3.num, 0) + t4.num) as total
    FROM (
        SELECT CONCAT(SUBSTR(start_time,1,5),'_',SUBSTR(end_time,1,5)) as time_gap, course_name, count(*) AS num, GROUP_CONCAT(student_name ORDER BY student_name ASC) as name
        FROM school_student_attendance_info
        WHERE dt=#{day} 
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
        GROUP BY start_time,end_time,course_name
    ) t3 RIGHT JOIN (
        SELECT CONCAT(SUBSTR(start_time,1,5),'_',SUBSTR(end_time,1,5)) as time_gap, course_name, count(*) AS num, GROUP_CONCAT(student_name ORDER BY student_name ASC) as name
        FROM school_student_attendance_exist_info
        WHERE dt=#{day} 
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
        GROUP BY start_time,end_time,course_name
    ) t4 ON t3.time_gap = t4.time_gap AND t3.course_name = t4.course_name
    WHERE t3.time_gap IS NULL
) t5
ORDER BY t5.time_gap ASC
	</select>
	
	
	
     <!--    SELECT CONCAT(SUBSTR(start_time,1,5),'_',SUBSTR(end_time,1,5)) as time_gap, course_name, GROUP_CONCAT(student_name order by student_name asc) as name, count(*) AS rs
        FROM school_student_attendance_info
        WHERE dt=#{day} AND (grade_name = #{grade_name} or ''=#{grade_name}) and (class_name = #{class_name} or ''=#{class_name})
        GROUP BY start_time,end_time,course_name
        order by time_gap asc -->
	
	<select id="getcolscls" resultType="java.util.HashMap">
SELECT
'time_gap' as prop,
'时间' as label
union
SELECT
'course_name' as prop,
'科目' as label
union
select
'total' as prop,
'总人数' as label
union
SELECT
'num' as prop,
'缺勤人数' as label
union
SELECT
'name' as prop,
'缺勤姓名' as label
union
select
'attend_name' as prop,
'出勤姓名' as label
</select>


<select id="getqxdatacls" resultType="java.util.HashMap">
SELECT
        case when t1.student_emotion=0 then '开心'
when t1.student_emotion=1 then '正常'
when t1.student_emotion=2 then '低落' ELSE '其他' end  as `name`, ROUND((1.0 * t1.num) / t2.total * 100, 2) AS `value`
    FROM
    (
        SELECT
            student_emotion, COUNT(*) AS num
        FROM student_mental_status_ld
        WHERE   dt = #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
        GROUP BY student_emotion
    ) t1 JOIN
    (
        SELECT
            COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE  dt = #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
    ) t2
</select>

<select id="getrjdatacls"  resultType="java.util.HashMap">
SELECT
        case when t1.student_relationship=0 then '非常好'
when t1.student_relationship=1 then '良好'
when t1.student_relationship=2 then '正常' when t1.student_relationship=3 then '孤僻' ELSE '其他' end   as name, ROUND((1.0 * t1.num) / t2.total * 100, 2) AS value
    FROM
    (
        SELECT
            student_relationship, COUNT(*) AS num
        FROM student_mental_status_ld
        WHERE  dt = #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
        GROUP BY student_relationship
    ) t1 JOIN
    (
        SELECT
            COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE  dt = #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
    ) t2

</select>

<select id="getxxdatacls"  resultType="java.util.HashMap">
SELECT
        case when t1.student_study_stat=0 then '非常好'
when t1.student_study_stat=1 then '良好'
when t1.student_study_stat=2 then '正常' when t1.student_study_stat=3 then '不佳' ELSE '其他' end  as name, ROUND((1.0 * t1.num) / t2.total * 100, 2) AS value
    FROM
    (
        SELECT
            student_study_stat, COUNT(*) AS num
        FROM student_mental_status_ld
        WHERE  dt = #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
        GROUP BY student_study_stat
    ) t1 JOIN
    (
        SELECT
            COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE  dt = #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
    ) t2

</select>
<select id="getjsdatacls"  resultType="java.util.HashMap">
SELECT
        case when t1.student_mental_stat=0 then '积极'
when t1.student_mental_stat=1 then '正常'
when t1.student_mental_stat=2 then '疲惫'  ELSE '其他' end as name, ROUND((1.0 * t1.num) / t2.total * 100, 2) AS value
    FROM
    (
        SELECT
            student_mental_stat, COUNT(*) AS num
        FROM student_mental_status_ld
        WHERE  dt = #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
        GROUP BY student_mental_stat
    ) t1 JOIN
    (
        SELECT
            COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE   dt = #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
    ) t2
</select>

<select id="getxkxqdatacls"  resultType="java.util.HashMap">
  SELECT
        student_interest, COUNT(*) AS total
    FROM student_mental_status_interest_daily
    WHERE   dt = #{day}
    <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
    GROUP BY student_interest
    ORDER BY student_interest ASC;
</select>

<select id="getyjdatacls"  resultType="java.util.HashMap">
SELECT '情绪不佳' as name,GROUP_CONCAT(student_name separator ',') as value
    FROM (
        SELECT student_number, student_name, count(*) as num
        FROM student_mental_status_ld
        WHERE dt &gt;=date_sub(str_to_date(#{day},'%Y-%m-%d'),interval 15 DAY) AND dt &lt;=#{day} AND student_emotion='2'
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
        GROUP BY student_number, student_name
        HAVING num &gt;=6
    )t1 
    union
     SELECT '精神状态不佳' as name,GROUP_CONCAT(student_name separator ',') as value
    FROM (
        SELECT student_number, student_name, count(*) as num
        FROM student_mental_status_ld
        WHERE dt &gt;=date_sub(str_to_date(#{day},'%Y-%m-%d'),interval 15 DAY) AND dt &lt;=#{day} AND student_mental_stat='2' 
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
        GROUP BY student_number, student_name
        HAVING num &gt;=6
    )t1 
    union
    SELECT '学习状态不佳' as name,GROUP_CONCAT(student_name separator ',') as value
    FROM (
        SELECT student_number, student_name, count(*) as num
        FROM student_mental_status_ld
        WHERE dt &gt;=date_sub(str_to_date(#{day},'%Y-%m-%d'),interval 15 DAY) AND dt &lt;=#{day} AND student_study_stat='3' 
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
        GROUP BY student_number, student_name
        HAVING num &gt;=6
    )t1 



</select>

<select id="getqxtime"  resultType="java.util.HashMap">
SELECT
        t1.dt, t1.student_emotion, ROUND((1.0 * t1.num) / t2.total * 100, 2) AS percentage
    FROM
    (
        SELECT
            dt, student_emotion, COUNT(*) AS num
        FROM student_mental_status_ld
        WHERE   dt &gt;= date_sub(str_to_date(#{day},'%Y-%m-%d'),interval 15 DAY) AND dt &lt;= #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
        GROUP BY dt, student_emotion
    ) t1 JOIN
    (
        SELECT
            dt, COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE  dt &gt;= date_sub(str_to_date(#{day},'%Y-%m-%d'),interval 15 DAY) AND dt &lt;= #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
        GROUP BY dt
    ) t2 ON t1.dt = t2.dt
    ORDER BY dt ASC

</select>

<select id="getjstime"  resultType="java.util.HashMap">
SELECT
        t1.dt, t1.student_mental_stat, ROUND((1.0 * t1.num) / t2.total * 100, 2) AS percentage
    FROM
    (
        SELECT
            dt, student_mental_stat, COUNT(*) AS num
        FROM student_mental_status_ld
        WHERE   dt &gt;= date_sub(str_to_date(#{day},'%Y-%m-%d'),interval 15 DAY) AND dt &lt;= #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
        GROUP BY dt, student_mental_stat
    ) t1 JOIN
    (
        SELECT
            dt, COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE   dt &gt;= date_sub(str_to_date(#{day},'%Y-%m-%d'),interval 15 DAY) AND dt &lt;= #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
        GROUP BY dt
    ) t2 ON t1.dt = t2.dt
    ORDER BY dt ASC

</select>
<select id="getxxtime"  resultType="java.util.HashMap">
SELECT
        t1.dt, t1.student_study_stat, ROUND((1.0 * t1.num) / t2.total * 100, 2) AS percentage
    FROM
    (
        SELECT
            dt, student_study_stat, COUNT(*) AS num
        FROM student_mental_status_ld
        WHERE    dt &gt;= date_sub(str_to_date(#{day},'%Y-%m-%d'),interval 15 DAY) AND dt &lt;= #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
        GROUP BY dt, student_study_stat
    ) t1 JOIN
    (
        SELECT
            dt, COUNT(*) AS total
        FROM student_mental_status_ld
        WHERE    dt &gt;= date_sub(str_to_date(#{day},'%Y-%m-%d'),interval 15 DAY) AND dt &lt;= #{day}
        <if test="college_name != null ">
and college_name=#{college_name}
</if>
<if test="grade_name != null ">
and grade_name=#{grade_name}
</if>
<if test="class_name != null ">
and class_name=#{class_name}
</if>
        GROUP BY dt
    ) t2 ON t1.dt = t2.dt
    ORDER BY dt ASC

</select>

<!-- 班级结束 -->




</mapper>